
pipeline {
    agent any

    options {
        skipDefaultCheckout()
        timestamps()
    }

    environment {
        // Repo Git
        GIT_REPO_URL = 'https://github.com/Nozha92/jenkins_demo_nozha.git'
        GIT_BRANCH   = 'main'

        // Docker / Docker Hub
        DOCKER_IMAGE     = 'nozha92/jenkins-demo-nozha'
        DOCKER_TAG       = 'latest'
        DOCKERHUB_CREDS  = 'dockerhub-creds'   // ID des credentials Docker Hub dans Jenkins

        // D√©ploiement local
        APP_NAME        = 'jenkins_demo_nozha_app'
        HOST_PORT       = '5002'  // port sur ton Mac
        CONTAINER_PORT  = '5000'  // port dans le conteneur Flask
    }

    stages {

        stage('Checkout SCM') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${GIT_BRANCH}"]],
                    userRemoteConfigs: [[url: "${GIT_REPO_URL}"]]
                ])
            }
        }

        stage('Build') {
            steps {
                echo 'üß± √âtape Build (rien √† compiler pour l‚Äôinstant)'
            }
        }

        stage('Tests') {
            steps {
                sh '''
                  echo "‚ñ∂Ô∏è Lancement des tests Python"
                  python3 script.py
                '''
            }
        }

        stage('Docker Build & Push') {
            steps {
                echo 'üê≥ Build & push de l‚Äôimage Docker'
                sh '''
                  docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
                '''
                withCredentials([
                    usernamePassword(
                        credentialsId: "${DOCKERHUB_CREDS}",
                        usernameVariable: 'DOCKERHUB_USER',
                        passwordVariable: 'DOCKERHUB_PWD'
                    )
                ]) {
                    sh '''
                      echo "üîê Login Docker Hub"
                      echo "${DOCKERHUB_PWD}" | docker login -u "${DOCKERHUB_USER}" --password-stdin

                      echo "‚¨ÜÔ∏è Push de l‚Äôimage Docker"
                      docker push ${DOCKER_IMAGE}:${DOCKER_TAG}

                      docker logout
                    '''
                }
            }
        }

        stage('Deploy local (Docker)') {
            steps {
                echo 'üöÄ D√©ploiement local de l‚Äôapplication'
                sh '''
                  set -e

                  IMAGE="${DOCKER_IMAGE}:${DOCKER_TAG}"

                  echo "üõë Stop & remove √©ventuel conteneur ${APP_NAME}"
                  if docker ps -a --format '{{.Names}}' | grep -q "^${APP_NAME}$"; then
                    docker stop ${APP_NAME} || true
                    docker rm ${APP_NAME} || true
                  fi

                  echo "üì• Pull de l‚Äôimage ${IMAGE}"
                  docker pull "${IMAGE}"

                  echo "üöÄ Lancement du conteneur sur ${HOST_PORT} -> ${CONTAINER_PORT}"
                  docker run -d --name ${APP_NAME} -p ${HOST_PORT}:${CONTAINER_PORT} "${IMAGE}"

                  echo "‚úÖ Conteneur d√©marr√© :"
                  docker ps | grep ${APP_NAME} || (echo "Conteneur non d√©marr√©" && exit 1)
                '''
            }
        }
    }

    post {
        success {
            echo '‚úÖ Pipeline termin√© avec SUCCESS'
        }
        failure {
            echo '‚ùå Pipeline en √©chec ‚Äì v√©rifier les logs'
        }
        always {
            echo '‚ÑπÔ∏è Fin d‚Äôex√©cution du pipeline'
        }
    }
}
