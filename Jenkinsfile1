pipeline {
    agent any

    environment {
        // üîê IDs des credentials Jenkins (d√©j√† cr√©√©s)
        DOCKERHUB_CREDS = 'dockerhub-creds'
        GITHUB_CREDS    = 'github-creds'

        // üåê Git
        GIT_REPO_URL = 'https://github.com/Nozha92/jenkins_demo_nozha.git'
        GIT_BRANCH   = 'main'

        // üê≥ Docker / Docker Hub
        DOCKERHUB_USER = 'nozha92'
        IMAGE_NAME     = 'nozha92/jenkins-demo-nozha'
        IMAGE_LATEST   = 'nozha92/jenkins-demo-nozha:latest'

        // üöÄ D√©ploiement
        CONTAINER_NAME = 'jenkins_demo_nozha_app'
        APP_PORT       = '5000'   // port expos√© sur la machine Jenkins
    }

    stages {

        stage('Build') {
            steps {
                echo "üèóÔ∏è D√©marrage du pipeline ${env.JOB_NAME} #${env.BUILD_NUMBER}"
            }
        }

        stage('Clone GitHub (CLI)') {
            steps {
                withCredentials([usernamePassword(
                        credentialsId: "${GITHUB_CREDS}",
                        usernameVariable: 'GIT_USER',
                        passwordVariable: 'GIT_TOKEN'
                )]) {
                    sh '''
                        rm -rf repo_tmp
                        mkdir repo_tmp
                        cd repo_tmp

                        echo "üì• Clonage du d√©p√¥t GitHub"
                        git clone --branch "$GIT_BRANCH" "https://${GIT_USER}:${GIT_TOKEN}@github.com/Nozha92/jenkins_demo_nozha.git" .

                        echo "üìÅ Contenu du repo :"
                        ls -al
                    '''
                }
            }
        }

        stage('Tests Python') {
            steps {
                sh '''
                    cd repo_tmp
                    echo "‚ñ∂Ô∏è Ex√©cution du script Python"
                    python3 script.py
                '''
            }
        }

        stage('Docker Build & Push') {
            steps {
                withCredentials([usernamePassword(
                        credentialsId: "${DOCKERHUB_CREDS}",
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh '''
                        cd repo_tmp

                        echo "üê≥ Connexion √† Docker Hub"
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin

                        IMAGE_ID="${IMAGE_NAME}:build-${BUILD_NUMBER}"

                        echo "üèóÔ∏è Build de l'image Docker $IMAGE_ID"
                        docker build -t "$IMAGE_ID" .

                        echo "üè∑Ô∏è Tag latest : ${IMAGE_LATEST}"
                        docker tag "$IMAGE_ID" "${IMAGE_LATEST}"

                        echo "üì§ Push des images vers Docker Hub"
                        docker push "$IMAGE_ID"
                        docker push "${IMAGE_LATEST}"

                        echo "üîì D√©connexion de Docker Hub"
                        docker logout || true
                    '''
                }
            }
        }

        // üí• NOUVEAU : d√©ploiement automatique
        stage('Deploy') {
            steps {
                sh '''
                    echo "üöÄ D√©ploiement du conteneur ${CONTAINER_NAME}"

                    # Stop si un conteneur est d√©j√† en cours
                    if [ "$(docker ps -q -f name=${CONTAINER_NAME})" ]; then
                        echo "‚ö†Ô∏è Conteneur d√©j√† en cours, arr√™t..."
                        docker stop "${CONTAINER_NAME}"
                    fi

                    # Supprime le conteneur existant (m√™me arr√™t√©)
                    if [ "$(docker ps -aq -f name=${CONTAINER_NAME})" ]; then
                        echo "üßπ Suppression de l'ancien conteneur..."
                        docker rm "${CONTAINER_NAME}"
                    fi

                    echo "üì• R√©cup√©ration de la derni√®re image ${IMAGE_LATEST}"
                    docker pull "${IMAGE_LATEST}" || true

                    echo "‚úÖ Lancement du nouveau conteneur"
                    docker run -d \
                        --name "${CONTAINER_NAME}" \
                        -p ${APP_PORT}:5000 \
                        "${IMAGE_LATEST}"

                    echo "üëç Conteneur en cours d'ex√©cution :"
                    docker ps -f name="${CONTAINER_NAME}"
                '''
            }
        }

        stage('Archive artefacts') {
            steps {
                // adapte le chemin si besoin
                archiveArtifacts artifacts: 'repo_tmp/result_github.txt',
                                  fingerprint: true,
                                  allowEmptyArchive: true
            }
        }
    }

    post {
        always {
            echo "‚úÖ Pipeline termin√© (succ√®s ou √©chec)"
        }
        success {
            echo "üéâ Pipeline termin√©e avec SUCCESS"
        }
        failure {
            echo "‚ùå Pipeline en erreur"
        }
        cleanup {
            sh '''
                echo "üßπ Nettoyage du workspace Jenkins (repo_tmp)"
                rm -rf repo_tmp || true
            '''
        }
    }
}
