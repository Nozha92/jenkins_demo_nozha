pipeline {
    agent any

    environment {
        GIT_URL            = 'https://github.com/Nozha92/jenkins_demo_nozha.git'
        GIT_BRANCH         = 'main'

        DOCKER_IMAGE       = 'nozha92/jenkins-demo-nozha:latest'
        DOCKER_CREDENTIALS = 'dockerhub-creds'   // id Jenkins
        GIT_CREDENTIALS    = 'github-creds'      // id Jenkins
    }

    stages {

        stage('Build') {
            steps {
                echo '√âtape Build OK ‚úÖ'
            }
        }

        stage('Clone GitHub (CLI)') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: GIT_CREDENTIALS,
                        usernameVariable: 'GIT_USER',
                        passwordVariable: 'GIT_TOKEN'
                    )
                ]) {
                    sh '''
                        set -eux

                        # On nettoie un ancien clone √©ventuel
                        rm -rf repo_tmp

                        echo "üì• Clonage du d√©p√¥t GitHub"
                        git clone --branch "$GIT_BRANCH" \
                          "https://$GIT_USER:$GIT_TOKEN@github.com/Nozha92/jenkins_demo_nozha.git" \
                          repo_tmp

                        echo "üìÇ Contenu clon√© :"
                        ls -al repo_tmp
                    '''
                }
            }
        }

        stage('Tests Python') {
            steps {
                dir('repo_tmp') {
                    echo '‚ñ∂Ô∏è Lancement du script Python'
                    sh 'python3 script.py'
                }
            }
        }

        stage('Docker Build & Run & Push') {
            steps {
                dir('repo_tmp') {
                    script {
                        docker.withRegistry('https://registry.hub.docker.com', DOCKER_CREDENTIALS) {

                            echo 'üê≥ Build de l‚Äôimage Docker'
                            def img = docker.build(DOCKER_IMAGE)

                            echo '‚¨ÜÔ∏è Push de l‚Äôimage sur Docker Hub'
                            img.push()

                            echo '‚ñ∂Ô∏è Lancement du conteneur pour test'
                            sh "docker run --rm ${DOCKER_IMAGE}"
                        }
                    }
                }
            }
        }

        stage('Archive artefacts') {
            steps {
                dir('repo_tmp') {
                    echo 'üì¶ Archivage des artefacts (si pr√©sents)'
                    archiveArtifacts artifacts: 'result_github.txt', fingerprint: true, onlyIfSuccessful: false
                }
            }
        }
    }

    post {
        always {
            echo 'üìå Pipeline ex√©cut√© (succ√®s ou √©chec)'
            cleanWs()
        }
        success {
            echo '‚úÖ Pipeline termin√© avec SUCCESS'
        }
        failure {
            echo '‚ùå Pipeline en erreur'
        }
    }
}
       
