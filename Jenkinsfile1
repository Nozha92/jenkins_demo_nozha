
    pipeline {
    agent any

    environment {
        // üéØ Git
        GIT_REPO   = 'https://github.com/Nozha92/jenkins_demo_nozha.git'
        GIT_BRANCH = 'main'

        // üê≥ Docker Hub
        DOCKER_REPO = 'nozha92/jenkins-demo-nozha'
        IMAGE_TAG   = "build-${env.BUILD_NUMBER}"
        IMAGE_FULL  = "${DOCKER_REPO}:${IMAGE_TAG}"
        IMAGE_LATEST = "${DOCKER_REPO}:latest"

        // üöÄ D√©ploiement
        CONTAINER_NAME = 'jenkins_demo_nozha_app'
        APP_PORT       = '5000'   // port sur ta machine
    }

    stages {

        stage('Build') {
            steps {
                echo 'üîß √âtape Build OK'
            }
        }

        stage('Clone GitHub (CLI)') {
            steps {
                echo 'üì• Clonage du d√©p√¥t GitHub (CLI)'
                sh '''
                    set -eux
                    rm -rf repo_tmp
                    git clone --branch "${GIT_BRANCH}" "${GIT_REPO}" repo_tmp
                    cd repo_tmp
                    echo "üìÅ Contenu du repo :"
                    ls -al
                '''
            }
        }

        stage('Tests Python') {
            steps {
                echo 'üß™ Lancement des tests Python'
                sh '''
                    set -eux
                    cd repo_tmp
                    python3 script.py
                '''
            }
        }

        stage('Docker Build & Push') {
            steps {
                echo 'üê≥ Build & push Docker'
                sh '''
                    set -eux
                    cd repo_tmp

                    echo "üî® Build de l'image Docker ${IMAGE_FULL}"
                    docker build -t "${IMAGE_FULL}" .

                    echo "üè∑Ô∏è Tag en latest : ${IMAGE_LATEST}"
                    docker tag "${IMAGE_FULL}" "${IMAGE_LATEST}"

                    echo "üì§ Push des images vers Docker Hub"
                    docker push "${IMAGE_FULL}"
                    docker push "${IMAGE_LATEST}"
                '''
            }
        }

        // ‚≠ê‚≠ê NOUVELLE PARTIE : D√âPLOIEMENT AUTOMATIQUE ‚≠ê‚≠ê
        stage('Deploy') {
            steps {
                echo "üöÄ D√©ploiement du conteneur ${CONTAINER_NAME}"
                sh '''
                    set -eux

                    echo "üì• Pull de la derni√®re image"
                    docker pull "${IMAGE_LATEST}"

                    echo "üõë Stop ancien conteneur si pr√©sent"
                    if [ "$(docker ps -q -f name=${CONTAINER_NAME})" ]; then
                      docker stop "${CONTAINER_NAME}"
                    fi

                    echo "üßπ Suppression ancien conteneur (m√™me nom) si pr√©sent"
                    if [ "$(docker ps -aq -f name=${CONTAINER_NAME})" ]; then
                      docker rm "${CONTAINER_NAME}"
                    fi

                    echo "‚ñ∂Ô∏è Lancement du nouveau conteneur"
                    docker run -d \
                      --name "${CONTAINER_NAME}" \
                      -p ${APP_PORT}:5000 \
                      "${IMAGE_LATEST}"

                    echo "‚úÖ D√©ploiement termin√©"
                '''
            }
        }

        stage('Archive artefacts') {
            steps {
                echo 'üì¶ Archivage des artefacts (ex: result_github.txt si besoin)'
                // archiveArtifacts artifacts: 'repo_tmp/result_github.txt', fingerprint: true, onlyIfSuccessful: true
            }
        }
    }

    post {
        always {
            echo 'üìå Pipeline ex√©cut√© (succ√®s ou √©chec)'
            // Nettoyage du workspace Jenkins
            cleanWs()
        }
        success {
            echo 'üíö Pipeline termin√© avec SUCCESS'
        }
        failure {
            echo 'üí• Pipeline en erreur'
        }
    }
}   
